<!DOCTYPE html>
<html lang="en">
    <head>    
        <title>PHP curl 并发最佳实践【转载】-『Honoer.com』Web技术</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="Description" content="web技术分享平台，技术的沉淀" />
        <meta name="Keywords" content="web技术，PHP，JS" />
        <meta property="qc:admins" content="514175567760767526375" />
        <link type="text/css" rel="stylesheet" href="/Honoer/Tpl/Home/Default/Public/Css/style.css"/>

        <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
        <link type="text/css" rel="stylesheet" href="/Public/Plugins/syntaxhighlighter/styles/shCore.css"/>
        <link type="text/css" rel="stylesheet" href="/Public/Plugins/syntaxhighlighter/styles/shThemeDefault.css"/>
        <script type='text/javascript' src="/Public/Plugins/jQuery/jquery-1.7.1.min.js"></script> 
        <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?45b34fa03392243e4038fd601390f9dc";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>        <script type='text/javascript'>
            <!--	
            var URL='/Article';
            var ROOT='';
            var PUBLIC='/Public';
            var Public='/Honoer/Tpl/Home/Default/Public';
            //-->
        </script>
    </head>  
    <body>
        <div class="header">
            <header class="clearfix">
                <hgroup>
    <a href="http://www.honoer.com" title="『Honoer.com』Web技术">
        <img alt="『Honoer.com』Web技术" src="/Honoer/Tpl/Home/Default/Public/Images/logo.gif">
    </a>
</hgroup>



<nav>
    <ul>
        <li >
                            <a href="/Index/index">首页</a>            </li><li class="active">
            <a class="nav-child" href="/Article/index">文章<i class="icon-caret"></i></a>
                <dl>
                    <dd >
                        <a href="/Article/index/cid/1">PHP</a>
                        </dd><dd >
                        <a href="/Article/index/cid/2">HTML</a>
                        </dd><dd >
                        <a href="/Article/index/cid/3">JS</a>
                        </dd>                </dl>
                            </li><li >
                            <a href="/About/index">关于Me</a>            </li>    </ul>
</nav>


<form class="search" action="/Article/index" method="get">
    <input name="keyword" placeholder="请输入关键词" type="text" value="">
    <button class="btn" name="search" value="Go!" type="submit">Go!</button>
<input type="hidden" name="__hash__" value="2c9012f38e82f07f252dbae31129f618_34bc457d853165eadb0defc814c077f9" /></form>
            </header>
        </div>
        <div class="wrap clearfix">
            <div class="span9">
    <article class="clearfix box">
        <div class="item-box">
                <span class="item-tit">
                    <h2>PHP curl 并发最佳实践【转载】</h2>
                </span>
                <div class="item-tags">
                    <span>Tags:PHP</span>
                    <span>Reply:83</span>
                    <span>Time:2012-07-27</span>
                    <span>Author:admin</span>
                </div>
                <div class="item-intro"><p>在实际项目或者自己编写小工具(比如新闻聚合,商品价格监控,比价)的过程中, 通常需要从第3方网站或者API接口获取数据, 在需要处理1个URL队列时, 为了提高性能, 可以采用cURL提供的curl_multi_*族函数实现简单的并发.<br /><br />本文将探讨两种具体的实现方法, 并对不同的方法做简单的性能对比.<br />1. 经典cURL并发机制及其存在的问题<br /><br />经典的cURL实现机制在网上很容易找到, 比如参考PHP在线手册的如下实现方式: <br /><br /></p><pre class="brush:php;">function classic_curl($urls, $delay) { 
    $queue = curl_multi_init(); 
    $map = array(); 
   
    foreach ($urls as $url) { 
        // create cURL resources 
        $ch = curl_init(); 
   
        // set URL and other appropriate options 
        curl_setopt($ch, CURLOPT_URL, $url); 
   
        curl_setopt($ch, CURLOPT_TIMEOUT, 1); 
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
        curl_setopt($ch, CURLOPT_HEADER, 0); 
        curl_setopt($ch, CURLOPT_NOSIGNAL, true); 
   
        // add handle 
        curl_multi_add_handle($queue, $ch); 
        $map[$url] = $ch; 
    } 
   
    $active = null; 
   
    // execute the handles 
    do { 
        $mrc = curl_multi_exec($queue, $active); 
    } while ($mrc == CURLM_CALL_MULTI_PERFORM); 
   
    while ($active &gt; 0 &amp;&amp; $mrc == CURLM_OK) { 
        if (curl_multi_select($queue, 0.5) != -1) { 
            do { 
                $mrc = curl_multi_exec($queue, $active); 
            } while ($mrc == CURLM_CALL_MULTI_PERFORM); 
        } 
    } 
   
    $responses = array(); 
    foreach ($map as $url=&gt;$ch) { 
        $responses[$url] = callback(curl_multi_getcontent($ch), $delay); 
        curl_multi_remove_handle($queue, $ch); 
        curl_close($ch); 
    } 
   
    curl_multi_close($queue); 
    return $responses; 
}</pre><p> </p><p>首先将所有的URL压入并发队列, 然后执行并发过程, 等待所有请求接收完之后进行数据的解析等后续处理. 在实际的处理过程中, 受网络传输的影响, 部分URL的内容会优先于其他URL返回, 但是经典cURL并发必须等待最慢的那个URL返回之后才开始处理, 等待也就意味着CPU的空闲和浪费. 如果URL队列很短, 这种空闲和浪费还处在可接受的范围, 但如果队列很长, 这种等待和浪费将变得不可接受.<br />2. 改进的Rolling cURL并发方式<br /><br />仔细分析不难发现经典cURL并发还存在优化的空间, 优化的方式时当某个URL请求完毕之后尽可能快的去处理它, 边处理边等待其他的URL返回, 而不是等待那个最慢的接口返回之后才开始处理等工作, 从而避免CPU的空闲和浪费. 闲话不多说, 下面贴上具体的实现:<br />3. 两种并发实现的性能对比<br /></p><pre class="brush:php;">function rolling_curl($urls, $delay) { 
    $queue = curl_multi_init(); 
    $map = array(); 
   
    foreach ($urls as $url) { 
        $ch = curl_init(); 
   
        curl_setopt($ch, CURLOPT_URL, $url); 
        curl_setopt($ch, CURLOPT_TIMEOUT, 1); 
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
        curl_setopt($ch, CURLOPT_HEADER, 0); 
        curl_setopt($ch, CURLOPT_NOSIGNAL, true); 
   
        curl_multi_add_handle($queue, $ch); 
        $map[(string) $ch] = $url; 
    } 
   
    $responses = array(); 
    do { 
        while (($code = curl_multi_exec($queue, $active)) == CURLM_CALL_MULTI_PERFORM) ; 
   
        if ($code != CURLM_OK) { break; } 
   
        // a request was just completed -- find out which one 
        while ($done = curl_multi_info_read($queue)) { 
   
            // get the info and content returned on the request 
            $info = curl_getinfo($done['handle']); 
            $error = curl_error($done['handle']); 
            $results = callback(curl_multi_getcontent($done['handle']), $delay); 
            $responses[$map[(string) $done['handle']]] = compact('info', 'error', 'results'); 
   
            // remove the curl handle that just completed 
            curl_multi_remove_handle($queue, $done['handle']); 
            curl_close($done['handle']); 
        } 
   
        // Block for data in / output; error handling is done by curl_multi_exec 
        if ($active &gt; 0) { 
            curl_multi_select($queue, 0.5); 
        } 
   
    } while ($active); 
   
    curl_multi_close($queue); 
    return $responses; 
}</pre><p> </p><p><br />改进前后的性能对比试验在LINUX主机上进行, 测试时使用的并发队列如下:<br /><br /> &nbsp; &nbsp;http://item.taobao.com/item.htm?id=14392877692<br /> &nbsp; &nbsp;http://item.taobao.com/item.htm?id=16231676302<br /> &nbsp; &nbsp;http://item.taobao.com/item.htm?id=17037160462<br /> &nbsp; &nbsp;http://item.taobao.com/item.htm?id=5522416710<br /> &nbsp; &nbsp;http://item.taobao.com/item.htm?id=16551116403<br /> &nbsp; &nbsp;http://item.taobao.com/item.htm?id=14088310973<br /><br />简要说明下实验设计的原则和性能测试结果的格式: 为保证结果的可靠, 每组实验重复20次, 在单次实验中, 给定相同的接口URL集合, 分别测量 Classic(指经典的并发机制)和Rolling(指改进后的并发机制)两种并发机制的耗时(秒为单位), 耗时短者胜出(Winner), 并计算节省的时间(Excellence, 秒为单位)以及性能提升比例(Excel. %). 为了尽量贴近真实的请求而又保持实验的简单, 在对返回结果的处理上只是做了简单的正则表达式匹配, 而没有进行其他复杂的操作. 另外, 为了确定结果处理回调对性能对比测试结果的影响, 可以使用usleep模拟现实中比较负责的数据处理逻辑(如提取, 分词, 写入文件或数据库等).<br /><br />性能测试中用到的回调函数为:<br /></p><pre class="brush:php;">function callback($data, $delay) { 
    preg_match_all('/&lt;h3&gt;(.+)&lt;\/h3&gt;/iU', $data, $matches); 
    usleep($delay); 
    return compact('data', 'matches'); 
}</pre><p> </p><p>数据处理回调无延迟时: Rolling Curl略优, 但性能提升效果不明显.<br />数据处理回调延迟5毫秒: Rolling Curl完胜, 性能提升40%左右.<br />通过上面的性能对比, 在处理URL队列并发的应用场景中Rolling cURL应该是更加的选择, 并发量非常大(1000+)时, 可以控制并发队列的最大长度, 比如20, 每当1个URL返回并处理完毕之后立即加入1个尚未请求的URL到队列中, 这样写出来的代码会更加健壮, 不至于并发数太大而卡死或崩溃. 详细的实现请参考: http://code.google.com/p/rolling-curl/ </p></div>
            </div>
            <div class="pager">
                <span>上一篇：&nbsp;<a href="/Article/read/aid/15" title="IE的条件注释">IE的条件注释</a></span>
                <span>下一篇：&nbsp;<a href="/Article/read/aid/17" title="jQuery 图片水平垂直居中 另一方法">jQuery 图片水平垂直居中 另...</a></span>
            </div>
             
    </article>
    <section class="hd-msg">
            </section>
    <section class="hd-form">
        
<fieldset>
    <legend>我来说一说</legend>
    <form class="form" action="/Article/reply/aid/16" method="post" role="validationFrom">
        <ul>
            <li>
                <label class="k"><em>*</em>Email:</label>
                <span class="v"><input type="text" name="comment_email" value="" datatype="e" errormsg="邮箱格式不正确！" ></span>
                <span class="Validform_checktip">邮箱不会公开~</span>
            </li>
            <li>
                <label class="k"><em>*</em>Content:</label>
                <span class="v"><textarea rows="4" cols="50" name="comment_content" datatype="*6-255"></textarea></span>
                <span class="Validform_checktip"></span>
            </li>
            <li>
                <label class="k">&nbsp;</label>
                <span class="v"><button type="submit" class="btn">留言</button></span>
            </li>
        </ul>
    <input type="hidden" name="__hash__" value="2c9012f38e82f07f252dbae31129f618_34bc457d853165eadb0defc814c077f9" /></form>
</fieldset>
    </section>
</div>
<div class="span3">
    <div class="tabs">
    <div class="tabs-tit">
        <h3>最新文章</h3>
    </div>
    <div class="tabs-box">
        <ul>
            <li>
                    <a href="/Article/read/aid/50" title="222222222"><small>07/23</small>222222222</a>
                </li><li>
                    <a href="/Article/read/aid/48" title="12312312"><small>05/24</small>12312312</a>
                </li><li>
                    <a href="/Article/read/aid/46" title="JSONP跨域实例"><small>05/16</small>JSONP跨域实例</a>
                </li><li>
                    <a href="/Article/read/aid/45" title="jQuery 点击空白地方便的点击展开/关闭效果非常方便的点击展开/关闭效果"><small>05/16</small>jQuery 点击空白地方便的点击展...</a>
                </li><li>
                    <a href="/Article/read/aid/44" title="专业的身份证验证，不用正则验证身份证"><small>04/29</small>专业的身份证验证，不用正则验证...</a>
                </li><li>
                    <a href="/Article/read/aid/43" title="用php实现Google /Baidu Ping服务快速收录"><small>04/13</small>用php实现Google /Baidu Ping服...</a>
                </li><li>
                    <a href="/Article/read/aid/42" title="计算两个日期相差 年 月 日"><small>04/13</small>计算两个日期相差 年 月 日</a>
                </li><li>
                    <a href="/Article/read/aid/41" title="PHP字符串截取，支持gb2312和UTF-8编码。"><small>04/13</small>PHP字符串截取，支持gb2312和UT...</a>
                </li>        </ul>
    </div>
</div>
<div class="tabs">
    <div class="tabs-tit">
        <h3>热门文章</h3>
    </div>
    <div class="tabs-box">
        <ul>
            <li>
                    <a href="/Article/read/aid/20" title="clearfix清除浮动闭合容器之:after与:before"><small>3088</small>clearfix清除浮动闭合容器之:af...</a>
                </li><li>
                    <a href="/Article/read/aid/1" title="iframe自动适应高度1"><small>213</small>iframe自动适应高度1</a>
                </li><li>
                    <a href="/Article/read/aid/2" title="图片水平垂直居中jquery-center-image"><small>147</small>图片水平垂直居中jquery-center...</a>
                </li><li>
                    <a href="/Article/read/aid/5" title="jQuery返回顶部代码"><small>125</small>jQuery返回顶部代码</a>
                </li><li>
                    <a href="/Article/read/aid/46" title="JSONP跨域实例"><small>115</small>JSONP跨域实例</a>
                </li><li>
                    <a href="/Article/read/aid/17" title="jQuery 图片水平垂直居中 另一方法"><small>114</small>jQuery 图片水平垂直居中 另一方法</a>
                </li><li>
                    <a href="/Article/read/aid/18" title="jQuery常用技巧"><small>114</small>jQuery常用技巧</a>
                </li><li>
                    <a href="/Article/read/aid/22" title="弹出窗口插件colorbox "><small>114</small>弹出窗口插件colorbox </a>
                </li>        </ul>
    </div>
</div>
<div class="tabs">
    <div class="tabs-tit">
        <h3>文章分类</h3>
    </div>
    <div class="tabs-box">
        <ul>
            <li >
                    <a href="/Article/index/date/2013-07" title="2013-07"><small>1</small>2013-07</a>
                </li><li >
                    <a href="/Article/index/date/2013-05" title="2013-05"><small>3</small>2013-05</a>
                </li><li >
                    <a href="/Article/index/date/2013-04" title="2013-04"><small>5</small>2013-04</a>
                </li><li >
                    <a href="/Article/index/date/2012-11" title="2012-11"><small>4</small>2012-11</a>
                </li><li >
                    <a href="/Article/index/date/2012-10" title="2012-10"><small>4</small>2012-10</a>
                </li><li >
                    <a href="/Article/index/date/2012-09" title="2012-09"><small>6</small>2012-09</a>
                </li><li >
                    <a href="/Article/index/date/2012-08" title="2012-08"><small>6</small>2012-08</a>
                </li><li >
                    <a href="/Article/index/date/2012-07" title="2012-07"><small>14</small>2012-07</a>
                </li><li >
                    <a href="/Article/index/date/2012-06" title="2012-06"><small>5</small>2012-06</a>
                </li>        </ul>
    </div>
</div>
</div>
        </div>
        <div class="footer">
            <footer class="clearfix">
                
<div class="user-login">
    <a href="/Login/qq_login"><img src="/Honoer/Tpl/Home/Default/Public/Images/qq_login.png"></a>	
</div>
<div class="copyright">
        ®copyright ©2012 All Rights Reserved.&nbsp;&nbsp;友情链接请E-mail：bily@honoer.com</div>

            </footer>
        </div>
        <script type='text/javascript' src="/Public/Plugins/jQuery/Validform_v5.3.2_min.js"></script>
        <script type="text/javascript" src="/Public/Plugins/jQuery/jquery.lazyload.min.js"></script>
        <script type="text/javascript" src="/Public/Plugins/syntaxhighlighter/scripts/brush.js"></script>
        <script type="text/javascript" src="/Honoer/Tpl/Home/Default/Public/Js/function.js"></script>
            </body>
</html>