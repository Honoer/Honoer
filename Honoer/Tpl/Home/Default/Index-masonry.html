
<style type="text/css">
    .item{
        border: 1px solid #D4D4D4;
        color: red;
        margin: 0 10px 10px 0;
        padding: 10px;
        position: relative;
        width: 200px;
    }
    .loading-wrap{
        bottom: 50px;
        width: 100%;
        height: 52px;
        text-align: center;
        display: none;
    }
    .loading {
        padding: 10px 10px 10px 52px;
        height: 32px;
        line-height: 28px;
        color: #FFF;
        font-size: 20px;
        border-radius: 5px;
        background: 10px center rgba(0,0,0,.7);
    }
</style>
<!--样式-->

<!--引入所需要的jquery和插件-->
<script type="text/javascript" src="__PUBLIC__/Plugins/jQuery/jquery.masonry.min.js"></script>
<!--引入所需要的jquery和插件-->
<!--瀑布流-->

<!--这里通过设置每个div不同的高度，来凸显布局的效果-->
<volist name="height" id="vo">
    <div class="item" style="height:{$vo}px;">瀑布流下来了</div>
</volist>
<!--瀑布流-->
<!--加载中-->
<div id="loading" class="loading-wrap">
    <span class="loading">加载中，请稍后...</span>
</div>
<!--加载中-->
<!--尾部-->

<!--尾部-->
<script type="text/javascript">
    $(function(){
        //页面初始化时执行瀑布流
        var $wrap = $('.wrap');
        $wrap.masonry({
            itemSelector : '.item',
            isAnimated: true
        });
        //用户拖动滚动条，达到底部时ajax加载一次数据
        var loading = $("#loading").data("masonry", false);//通过给loading这个div增加属性on，来判断执行一次ajax请求
        $(window).scroll(function(){
            if(loading.data("masonry")) return;
            var h =$(document).height()-$(window).height()-$('.footer').height();
            var url = "{:U('Index/more')}";
            //页面拖到底部了
            if($(document).scrollTop() > h){
                
                //加载更多数据
                loading.data("masonry", true).fadeIn();         //在这里将on设为true来阻止继续的ajax请求
                $.ajax({
                    url:url,
                    dataType:'json',
                    success:function(data){
                        //获取到了数据data,后面用JS将数据新增到页面上
                        var html = "";
                        if(!$.isEmptyObject(data)){
                            for(i in data){
                                html += "<div class=\"item\" style=\"height:"+data[i]+"px;\">瀑布又流下来了</div>";
                            }
                            var $newElems = $(html).css({ opacity: 0 }).appendTo($wrap);
                            $newElems.imagesLoaded(function(){
                                $newElems.animate({ opacity: 1 });
                                $wrap.masonry('appended', $newElems, true ); 
                            });
                            //一次请求完成，将on设为false，可以进行下一次的请求
                            loading.data("masonry", false);
                        }
                        loading.fadeOut();
                    }
                });
            }
        });
    });
</script>
